---
title: "Target aggregate data adjustment transportability analysis"
author: "Core Clinical Sciences"
output: rmarkdown::html_vignette
bibliography: references.bib

vignette: >
  %\VignetteIndexEntry{Target aggregate data adjustment transportability analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, echo = FALSE}
library(TransportHealth)

expit <- function(x) 1/(1+exp(-x))

# ---------- Generate test data for TADA for TransportHealth ----------
generateTestDataTADA <- function() {
  
  # ---------- Generate study data in IPD ----------
  nStudy <- 1000
  
  sexStudy <- rbinom(nStudy, 1, 0.5) # Male is 1, so female is baseline
  stressStudy <- rbinom(nStudy, 1, 0.4) # Stressed is 1
  med2Study <- rbinom(nStudy, 1, 0.1) # 1 means taking other med
  percentBodyFatStudy <- rnorm(nStudy, 28 - 13 * sexStudy, 2)
  toxicGradeStudy <- sample(c("Low", "Medium", "High"), size = nStudy, replace = TRUE, prob = c(0.7, 0.15, 0.15))
  
  # treatment
  med1Study <- rbinom(nStudy, 1, expit(0.2 * sexStudy - 0.02 * percentBodyFatStudy + 0.1 * stressStudy))
  # response
  sysBloodPressureStudy <- rnorm(nStudy, 100 + 5 * sexStudy + 0.5 * percentBodyFatStudy + 5 * stressStudy -
                                   5 * med1Study + med1Study * (-5 * med2Study + 7 * stressStudy))
  
  
  # Put all variables together
  studyData <- data.frame( sysBloodPressure = sysBloodPressureStudy, # response
                           med1 = as.factor(med1Study), # treatment
                           
                           sex = as.factor(sexStudy), 
                           stress = as.factor(stressStudy), 
                           med2 = as.factor(med2Study), 
                           toxicGrade = as.factor(toxicGradeStudy),
                           percentBodyFat = percentBodyFatStudy)
  
  
  
  # ---------- Generate target data in AgD ----------
  nTarget <- 1500
  
  sexTarget <- rbinom(nTarget, 1, 0.3) # Male is 1, so female is baseline
  stressTarget <- rbinom(nTarget, 1, 0.7) # Stressed is 1
  med2Target <- rbinom(nTarget, 1, 0.3) # 1 means taking other med
  percentBodyFatTarget <- rnorm(nTarget, 26 - 12 * sexTarget, 2)
  toxicGradeTarget <- sample(c("Low", "Medium", "High"), size = nTarget, replace = TRUE, prob = c(0.45, 0.35, 0.20))

  # Put all variables together
  targetData <- data.frame(N = nTarget,
                           
                           # binary
                           sex_count = sum(sexTarget), # count of Male
                           sex_prop = 0.93, # an incorrect value to test the replacement function, the new prop should be calculated based on 
                           
                           stress_prop = sum(stressTarget)/nTarget, # proportion of stress
                           
                           med2_PROP = sum(med2Target)/nTarget, 
                           
                           # ordinal with three subclass
                           toxicGrade_LOW_prop = as.numeric(table(toxicGradeTarget)["Low"]) / nTarget,
                           toxicGrade_Medium_COUNT = as.numeric(table(toxicGradeTarget)["Medium"]),
                           # We don't need to prop for reference level candidate
                           # like: for male and female we just need to provide one of two and it's informative
                           # OR: user could provide all AgD for all levels and we could detect the ref level by the first element of factor IPD
                           toxicGrade_high_prop = as.numeric(table(toxicGradeTarget)["High"]) / nTarget,
                           
                           # continuous
                           percentBodyFat_mean = mean(percentBodyFatTarget),
                           percentBodyFat_sd = sd(percentBodyFatTarget),
                           percentBodyFat_median = median(percentBodyFatTarget)
                           )
  

  return(list(studyData = studyData, 
              aggregateTargetData = targetData))
}

testData <- generateTestDataTADA()

```

# Introduction

In this vignette, we demonstrate how to use `TransportHealth` for weighting-based transportability analysis when individual participant-level data (IPD) is available for the original population, while only aggregate-level data (AgD) is available for the target sample.

## Brief introduction to Target aggregate data adjustment (TADA)

In transportability and generalizability analysis using the TADA method, the process differs from traditional inverse odds of participation weighting (IOPW) or g-computation due to the absence of individual-level data (IPD) in the target population. Firstly, a model of the outcome in terms of treatment, covariates, and effect modifiers is fitted using the source data. Then, instead of using individual-level covariate and effect modifier values from the target data, the aggregate-level data (AgD) from the target population is used to adjust the distribution of these variables in the source model by method of moments. This allows for the calculation of fitted values of the outcome under different treatment scenarios, with the target population characteristics reflected through the aggregate data. Finally, treatment effects are calculated using these adjusted fitted values to obtain an estimate of the treatment effect in the target population.

# Example

Suppose we are interested in estimating the causal effect of a medication on systolic blood pressure in a target population, but we were only able to conduct an observational study using samples from the study population. To obtain unbiased causal effect estimates using the study sample, we account for the following covariates: sex, body fat percentage, and stress level.

We wish to know know that the effectiveness of the medication depends on two effect modifiers of stress levels and whether patients are taking another medication.

*Note that the covariates adjusted for in the study data can also be effect modifiers.*

## Coded variables:

-   Medication - `med1`

    -   `1` for treated
    -   `0` for non-treated

-   Systolic blood pressure (SBP) - `sysBloodPressure` (continuous)

-   Sex - `sex`

    -   `1` for male
    -   `0` for female

-   Body fat percentage - `percentBodyFat` (continuous)

-   Toxicity Grade - `toxicGrade`
    
    -   `Low` for low grade
    -   `Medium` for medium grade
    -   `High` for high grade

-   Stress level - `stress`

    -   `1` for stressed
    -   `0` for normal

-   Medication 2 - `med2`

    -   `1` for treated
    -   `0` for non-treated


## Analyses

First, for the implementation of TADA in `TransportHealthR` specifically, the data from the study and target population should be separate data frames in the `R` environment. The study data should contain response, treatment, covariate and effect modifier information, while the target data should contain only aggregate level summary statistics of covariate and effect modifier such as proportion, count, mean, median and standard deviation. 

Suppose that we have the study and target data separately as follows.

```{r exampleData, echo = T}
names(testData)
print("Study data:")
head(testData$studyData)
print("Target data:")
head(testData$aggregateTargetData)

```

Here for the target data, We define corresponding canonical suffixes for the aggregate level statistics corresponding to each variable. 

-   For continuous variables, the mean of a variable should be named "variable_mean", the standard deviation of a variable should be named "variable_sd", the median of a variable should be named "variable_median". 

-   The proportion or count of a binary variable can be named "variable_prop" or "variable_count" respectively (corresponding to the category labelled as 1 in the study data). 

-   The naming method of ordinal variables is specified as "variable_category_AgD". For example, for an ordinal variable "toxicGrade" with three categories (low, medium and high), the proportions of each category recorded in the target data should be named "toxicGrade_low_prop", "toxicGrade_medium_prop" and "toxicGrade_high_prop".

We can now perform transportability analysis using TADA with the `transportTADA` functions.

```{r blankFunction, echo = T, eval = F}
transportTADA(msmFormula, 
              propensityScoreModel,
              matchingCovariates,
              propensityWeights,
              participationWeights,
              treatment,
              response,
              family,
              studyData,
              aggregateTargetData)

```

### Arguments for the `transportTADA` function

This function requires specification of the following arguments:

-   `msmFormula`: A formula expressing the marginal structural model (MSM) to be fit. 

-   `propensityScoreModel`: A formula or a `glm` object expressing the propensity model, i.e. a model of treatment assignment in terms of covariates. 

If a formula is provided, logistic regression is used by default. Custom propensity weights from other weighting methods can also be provided to the `customPropensity` argument instead; in this case, do not set `propensityScoreModel` because it is `NULL` by default and will be overridden.

-   `matchingCovariates`: A vector of user-specified covariates which are used for the data matching to obtain participation weights when no custom weights provided.

-   `propensityWeights`: A vector of custom weights balancing covariates between treatments. Providing them will override the formula or model provided by `propensityScoreModel`. This vector should have as any entries as the sample size of the study data.

-   `participationWeights`: A vector of custom weights balancing effect modifiers between study and target populations. This vector should have as any entries as the sample size of the study data.

-   `treatment`: The name of the variable indicating treatment.

-   `response`: The name of the variable indicating response.

-   `family`: The type of outcome model to be fit.

This can be any of the families that are used in `glm`, one of `"coxph"` or `"survreg"`. The `"coxph"` and `"survreg"` options are for survival analysis and will use default options of these methods from the `survival` package.

-   `studyData`: The individual participant data (IPD) of study population.

-   `aggregateTargetData`: The aggregate-level data (AgD) of target population.


### Specification of transportability analysis 

These components are put together as follows. 

Recall that: 
- `sysBloodPressure` is the response

- `med1` is the treatment

- `sex`, `percentBodyFat`, `toxicGrade`, and `stress` are covariates to be controlled in the original study

- `med2` (other medication) and `stress` are effect modifiers of interest. 

```{r TADA, echo = T}
result <- transportTADA(
  # MSM formula
  msmFormula = sysBloodPressure ~ med1,
  
  # Propensity model
  propensityScoreModel = med1 ~ sex + percentBodyFat + stress,
  
  # Matching covariates
  matchingCovariates = c("sex", "stress", "med2", "toxicGrade", "percentBodyFat"),
  
  # Name of treatment variable
  treatment = "med1", 
  
  # Name of response variable
  response = "sysBloodPressureStudy",
  
  # Type of MSM
  family = gaussian,
  
  # Study data
  studyData = testData$studyData,
  
  # Target data
  aggregateTargetData = testData$aggregateTargetData)

```


### Producing statistical results

To show the results of the analysis, we can use the `base::summary` function, similarly as one would use the `lm` function for fitting a linear model. 

This prints out a table of unweighted and weighted SMDs of covariates between treatment groups, a pre-post weighting table which includes unweighted and weighted aggregate level summary as well as pre- and post- difference values of effect modifiers of interest between study data and target data, and summaries of the fitted outcome model and the final marginal structural model (MSM) fit with the correct standard errors calculated using sandwich estimator or bootstrap. Note that scientific conclusions should only be drawn from the MSM.


```{r TADA-summary, echo = T}
summary(result)
```

**Positivity** and **conditional exchangeability** are two key assumptions that can affect the validity of transportability analysis. 

`Positivity` is the assumption that at all observed levels of covariates and effect modifiers, the probabilities of being in the treatment group and being the study are neither 0 nor 1, respectively. 

- To evaluate this assumption for the treatment assignment and study participation, use the `plot` function with `type = "propensityHist"`. This outputs mirrored histogram of probabilities of being in the treatment group for different treatment groups. Non-overlap of the ranges of the histograms suggest violations of the positivity assumption [@positivity]. 

```{r TADA-hist, echo = T}
base::plot(result, type = "propensityHist")
```

Use the `plot` function with `type = "participationHist"` will provide the histogram of participation weights and the effective sample size (ESS), which indicates the possible existence of extreme weights and the degree of ESS reduction. These information can justify the suitability of the TADA method.

```{r TADA-hist, echo = T}
base::plot(result, type = "participationHist")
```

`Conditional exchangeability` is roughly the assumption that the only possible confounding is due to the controlled covariates and effect modifiers. Under this assumption, TADA estimates will be reliable if the weighted distributions of covariates and effect modifiers are similar between treatment groups and the study data, respectively. This can be (partially) evaluated using standardized mean differences (SMDs), which are shown in table form by the `summary` function. The `plot` function with `type = "propensitySMD"` provides graphical versions of this table. A general guideline is that an SMD of below 0.1 indicates balance, but this threshold is arbitrary and left to the choice of the analyst [@balance].

```{r TADA-smd, echo = T}
base::plot(result, type = "propensitySMD")

```

Model coefficient plots showing confidence intervals of the effect estimates are provided by `plot` function with `type = "msm"`. The standard errors are the correct ones calculated by sandwich estimator or bootstrap.

```{r TADA-msm, echo = T}
base::plot(result, type = "msm")
```

Note that all plot outputs are designed to be generated with `ggplot2`. They can be customized further. 

## References

::: {#refs}
:::

